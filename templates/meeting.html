{% extends "base.html" %}
{% block title %}{{ meeting.date }} â€” Standup 3000{% endblock %}
{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;">
    <div style="display:flex; align-items:center; gap:0.75rem;">
        <div class="meeting-date" style="margin-bottom:0;">{{ meeting.date }}</div>
        {% if meeting.status == 'locked' %}
        <span class="lock-badge locked" title="Locked">&#128274;</span>
        {% endif %}
    </div>
    <div style="display:flex; gap:0.5rem; align-items:center;">
        {% if current_user and current_user.role == 'admin' %}
            {% if meeting.status == 'locked' %}
            <form method="post" action="{{ url_for('meeting_unlock', meeting_id=meeting.id) }}" style="margin:0;">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="outline" style="font-size:0.8rem; padding:0.3rem 0.8rem; border-radius:8px; margin:0;">Unlock</button>
            </form>
            {% else %}
            <form method="post" action="{{ url_for('meeting_lock', meeting_id=meeting.id) }}" style="margin:0;">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="outline" style="font-size:0.8rem; padding:0.3rem 0.8rem; border-radius:8px; margin:0;">Lock</button>
            </form>
            {% endif %}
        {% endif %}
        <a href="{{ url_for('meeting_export_markdown', meeting_id=meeting.id) }}" class="outline" role="button" style="font-size:0.8rem; padding:0.3rem 0.8rem; border-radius:8px;" title="Download as Markdown">Export</a>
        <a href="{{ url_for('meeting_present', meeting_id=meeting.id) }}" role="button" class="outline" style="font-size:0.9rem; padding:0.4rem 1rem; border-radius:8px;">Present</a>
    </div>
</div>

{% if meeting.status == 'locked' %}
<div class="locked-banner">This meeting is locked. Editing is disabled.</div>
{% endif %}

<!-- Attendance -->
<div id="attendance-panel" style="margin-bottom:1rem;">
    {% include "partials/attendance.html" %}
</div>

<div class="meeting-layout">
    <div class="main-sections">
        {% for section in sections %}
            {% if not section.is_special %}
            <article class="section-card">
                <div class="section-header">
                    <div>
                        <h3>{{ section.name }}{% set section_todos = todos_map.get(section.id, []) %}{% set open_todo_count = section_todos|rejectattr('done')|list|length %}{% if open_todo_count %} <span class="todo-badge">{{ open_todo_count }}</span>{% endif %}</h3>
                        {% if section.reporter %}
                        <span class="reporter">{{ section.reporter }}</span>
                        {% endif %}
                    </div>
                    <span class="htmx-indicator">saving...</span>
                </div>
                {% if can_edit(user, section) %}
                <div class="section-content"
                     id="section-{{ section.id }}"
                     hx-get="{{ url_for('section_edit', section_id=section.id) }}"
                     hx-trigger="click"
                     hx-swap="innerHTML"
                     hx-target="#section-{{ section.id }}">
                    {% include "partials/section_view_inner.html" %}
                </div>
                {% else %}
                <div class="section-content no-edit" id="section-{{ section.id }}">
                    {% include "partials/section_view_inner.html" %}
                </div>
                {% endif %}
                {% if meeting.status != 'locked' %}
                {% with todos = section_todos %}
                    {% include "partials/todo_list.html" %}
                {% endwith %}
                {% else %}
                {% with todos = section_todos, locked = true %}
                    {% include "partials/todo_list.html" %}
                {% endwith %}
                {% endif %}
            </article>
            {% endif %}
        {% endfor %}
    </div>

    <div class="sidebar">
        {% for section in sections %}
            {% if section.is_special %}
            <article class="section-card special">
                <div class="section-header">
                    <div>
                        <h3>{{ section.name }}</h3>
                    </div>
                    <span class="htmx-indicator">saving...</span>
                </div>
                {% if can_edit(user, section) %}
                <div class="section-content"
                     id="section-{{ section.id }}"
                     hx-get="{{ url_for('section_edit', section_id=section.id) }}"
                     hx-trigger="click"
                     hx-swap="innerHTML"
                     hx-target="#section-{{ section.id }}">
                    {% include "partials/section_view_inner.html" %}
                </div>
                {% else %}
                <div class="section-content no-edit" id="section-{{ section.id }}">
                    {% include "partials/section_view_inner.html" %}
                </div>
                {% endif %}
            </article>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}
